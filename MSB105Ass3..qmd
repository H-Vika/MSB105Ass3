---
title: "Assignment 3:"
subtitle:  "Pendling."
author: "Harald Vika"
date: last-modified
date-format: "dddd D MMM, YYYY"
csl: apa7.csl
lang: en-GB
format:
  html: default
  typst:
    papersize: a4
  pdf: 
    documentclass: article
    number-sections: true
    keep-tex: true
    papersize: A4
    fig-pos: "H"
abstract: ""
editor: 
  markdown: 
    wrap: sentence
echo: false
bibliography: references.bib
---

```{r}
library(tidyverse) |> suppressPackageStartupMessages()
library(lubridate) |> suppressPackageStartupMessages()
library(PxWebApiData) |> suppressPackageStartupMessages()
library(flextable) |> suppressPackageStartupMessages()
```

Her skal pendle-mønsteret bli studert mellom en norsk region. dette er seks regioner rundt Boknafjorden. Total i de seks regionene så er det 20 kommuner. I denne oppgaven skal vi ta for oss at hver region er et arbeidsmarked og vi skal studere arbeidspendlingene som foregår i de regionene. 
Formålet med oppgaven er å lære å hente inn data fra SSB via en API, samt skifte mellom "long" og "wide" format for dataene våre. Her skal vi lage et "tidy" datasett for alle pendling mellom disse regionnene for årene 2002-2024. 

```{r}
knr <- as.character(
  c(
    1102, 1103, 1108, 1124, 1127, 1120, 1122, 1121, 1119, 
    1144, 1130, 1106, 1146, 1149, 1216, 4612, 1145, 1133,
    1134, 1135, 1154, 1160, 1211, 4611, 1129, 1141, 1142
    )
  )
```
```{r}
#For at dokumentet skal kunne lese spesial bokstavene måtte jeg legge inn denne.
Sys.setlocale("LC_CTYPE", "UTF-8")
```

```{r}
knavn <- c(
  "Sandnes (-2019)", "Stavanger", "Nye-Sandnes",
  "Sola", "Randaberg", "Klepp", "Gjesdal", "Time",
  "Hå", "Kvitsøy", "Strand", "Haugesund", "Tysvær",
  "Karmøy", "Sveio (-2019)", "Sveio", "Bokn",
  "Hjelmeland", "Suldal", "Sauda", "Vindafjord (-2006)",
  "Vindafjord", "Etne (-2019)", "Etne",
  "Forsand (-2019)", "Finnøy (-2020)", "Rennesøy (-2020)"
)
# Då har vi fått inn noen values på kommunene 
```

```{r}
#Get more info about table
ApiData(
"http://data.ssb.no/api/v0/en/table/03321",
returnApiQuery = TRUE
) 
```

```{r}
pend_02_24_ssb_boBF <- ApiData12(
    urlToData = "03321",
    ArbstedKomm = list('*'),
    Bokommuen = knr, # Merk skrivemåten
    Tid = as.character(2002:2024)
)
```



```{r}
pend_02_24_boBF <- pend_02_24_ssb_boBF %>% 
  # Henter kommune navn fra desc df
  mutate(
    akom_navn = arbeidsstedskommune,
    bkom_navn = bostedskommune ,
    akom = paste("k", ArbstedKomm, sep = ""),
    bkom = paste("k", Bokommuen, sep = ""),
    # skifter navn og nummer for Etne og Sveio
    akom = ifelse(akom == "k1211", "k4611", akom),
    akom = ifelse(akom == "k1216", "k4612", akom),
    bkom = ifelse(bkom == "k1211", "k4611", bkom),
    bkom = ifelse(bkom == "k1216", "k4612", bkom),
    akom_navn = ifelse(akom_navn == "Etne (-2019)", "Etne", akom_navn),
    akom_navn = ifelse(akom_navn == "Sveio (-2019)", "Sveio", akom_navn),
    bkom_navn = ifelse(bkom_navn == "Etne (-2019)", "Etne", bkom_navn),
    bkom_navn = ifelse(bkom_navn == "Sveio (-2019)", "Sveio", bkom_navn)    
  ) %>% 
  # Endrer noen variabelnavn
  rename(
    aar = Tid,
    pendlere = value 
  )  %>%
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere) %>% 
  as_tibble()
```


```{r}
print(pend_02_24_boBF, n = 5)
```

```{r}
pend_02_24_ssb_arbBF <- ApiData12(
    urlToData = "03321",
    ArbstedKomm = knr,       # Alle arbeidsstedskommuner i Bokna-regionen
    Bokommuen = list('*'),   # Alle bostedskommuner i Norge
    Tid = as.character(2002:2024)
)
```

```{r}
pend_02_24_arbBF <- pend_02_24_ssb_arbBF %>% 
  # Henter kommune navn fra desc df
  mutate(
    akom_navn = arbeidsstedskommune,
    bkom_navn = bostedskommune ,
    akom = paste("k", ArbstedKomm, sep = ""),
    bkom = paste("k", Bokommuen, sep = ""),
    # skifter navn og nummer for Etne og Sveio
    akom = ifelse(akom == "k1211", "k4611", akom),
    akom = ifelse(akom == "k1216", "k4612", akom),
    bkom = ifelse(bkom == "k1211", "k4611", bkom),
    bkom = ifelse(bkom == "k1216", "k4612", bkom),
    akom_navn = ifelse(akom_navn == "Etne (-2019)", "Etne", akom_navn),
    akom_navn = ifelse(akom_navn == "Sveio (-2019)", "Sveio", akom_navn),
    bkom_navn = ifelse(bkom_navn == "Etne (-2019)", "Etne", bkom_navn),
    bkom_navn = ifelse(bkom_navn == "Sveio (-2019)", "Sveio", bkom_navn)    
  ) %>% 
  # Endrer noen variabelnavn
  rename(
    aar = Tid,
    pendlere = value 
  )  %>%
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere) %>% 
  as_tibble()
```

```{r}
print(pend_02_24_arbBF, n = 5)
```

## Kommunesammenslåingene
- Lage nye variabler nye_akom og nye_bkom som tar hensyn til kommmunesammeslåingen "nye stavanger" og "nye sandes" fra 01.01.2020. Legger også til en "super kommune" som er resten av landet (RAL) (fortsett å skrive mer etter å ha fått inn alle kodene)

```{r}
# knr Bokn-regionen utenom kommunene som inngår i Nye Stavanger,
# Nye Sandnes og Vindafjord
knr_u_SSV <- paste(
  "k", 
  c(
    1124, 1127, 1120, 1122, 1121, 1119, 1144, 1130, 1106, 1146, 1149, 1145, 1133, 1134, 1135,  1102, 4611, 4612
    ),
  sep = ""
)
```


## Bosted rundt Boknafjorden

```{r}
pend_02_24_boBF <- pend_02_24_boBF %>% 
  mutate(
    nye_bkom = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      bkom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      bkom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      # Øvrige  Bokna-region beholder sin bkom
      TRUE ~ bkom
    ),
    nye_bkom_navn = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      bkom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      bkom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      # Øvrige  Bokna-region beholder sitt bkom_navn
      TRUE ~ bkom_navn
    ),
    nye_akom = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      akom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      akom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      # Øvrige  Bokna-regionen beholder sin akom
      akom %in% knr_u_SSV ~ akom,   
      # Resten av landet kodes som knr "9999"
      TRUE ~ "k9999"
    ),
    nye_akom_navn = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      akom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      akom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      # Øvrige Bokna-regionen beholder sitt akom_navn
      akom %in% knr_u_SSV ~ akom_navn,  
      # Resten av landet kodes som knr "RAL"
      TRUE ~ "RAL"
      )
  )
```


```{r}
library(dplyr)

pend_02_24_boBF_sum <- pend_02_24_boBF %>% 
  group_by(
    aar,
    nye_akom,
    nye_akom_navn,
    nye_bkom,
    nye_bkom_navn
  ) %>% 
  summarise(
    pendlere = sum(pendlere, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
stavanger <- pend_02_24_boBF_sum %>% 
  filter(nye_akom == "k1103", nye_bkom == "k1103") %>% 
  arrange(aar)
```

```{r}
bkom_liste <- c(
  "k1103","k1106","k1108","k1119","k1120","k1121","k1122","k1124",
  "k1127","k1130","k1133","k1134","k1135","k1144","k1145","k1146",
  "k1149","k1160","k4611","k4612"
)

pend_02_24_boBF_bkom <- pend_02_24_boBF_sum %>% 
  filter(nye_bkom %in% bkom_liste)

```

```{r}
pend_02_24_boBF_agg <- pend_02_24_boBF %>%
    group_by(aar, nye_akom, nye_akom_navn, nye_bkom, nye_bkom_navn) %>%
    summarise(pendlere = sum(pendlere), .groups = "drop")
```


```{r}
pend_02_24_boBF_agg |>
  distinct(nye_akom) |> 
  pull(nye_akom) |> 
  print(width = 70)
```

## Arbeidssted Bokna-Regionen

```{r}
pend_02_24_arbBF <- pend_02_24_arbBF %>% 
  mutate(
    nye_bkom = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      bkom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      bkom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      # Øvrige  Bokna-region beholder sin bkom
      TRUE ~ bkom
    ),
    nye_bkom_navn = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      bkom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      bkom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      # Øvrige  Bokna-region beholder sitt bkom_navn
      TRUE ~ bkom_navn
    ),
    nye_akom = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      akom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      akom %in% c("k1154", "k1159", "k1160") ~ "k1160",
      # Øvrige  Bokna-regionen beholder sin akom
      akom %in% knr_u_SSV ~ akom,   
      # Resten av landet kodes som knr "9999"
      TRUE ~ "k9999"
    ),
    nye_akom_navn = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
      akom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
      akom %in% c("k1154", "k1159", "k1160") ~ "Vindafjord",
      # Øvrige Bokna-regionen beholder sitt akom_navn
      akom %in% knr_u_SSV ~ akom_navn,  
      # Resten av landet kodes som knr "RAL"
      TRUE ~ "RAL"
      )
  )
```


```{r}
library(dplyr)

pend_02_24_arbBF_sum <- pend_02_24_arbBF %>% 
  group_by(
    aar,
    nye_akom,
    nye_akom_navn,
    nye_bkom,
    nye_bkom_navn
  ) %>% 
  summarise(
    pendlere = sum(pendlere, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
stavanger <- pend_02_24_arbBF_sum %>% 
  filter(nye_akom == "k1103", nye_bkom == "k1103") %>% 
  arrange(aar)
```

```{r}
bkom_liste <- c(
  "k1103","k1106","k1108","k1119","k1120","k1121","k1122","k1124",
  "k1127","k1130","k1133","k1134","k1135","k1144","k1145","k1146",
  "k1149","k1160","k4611","k4612"
)

pend_02_24_arbBF_bkom <- pend_02_24_arbBF_sum %>% 
  filter(nye_bkom %in% bkom_liste)

```

```{r}
pend_02_24_arbBF_agg <- pend_02_24_arbBF %>%
    group_by(aar, nye_akom, nye_akom_navn, nye_bkom, nye_bkom_navn) %>%
    summarise(pendlere = sum(pendlere), .groups = "drop")
```


```{r}
pend_02_24_arbBF_agg |>
  distinct(nye_akom) |> 
  pull(nye_akom) |> 
  print(width = 70)
```

```{r}
pend_02_24_arbBF_agg <- pend_02_24_arbBF_agg |>
  rename(
    akom = nye_akom,
    akom_navn = nye_akom_navn,
    bkom = nye_bkom,
    bkom_navn = nye_bkom_navn
  )
```


```{r}
pend_02_24_boBF_agg <- pend_02_24_boBF_agg |>
  rename(
    akom = nye_akom,
    akom_navn = nye_akom_navn,
    bkom = nye_bkom,
    bkom_navn = nye_bkom_navn
  )
```

Tester for å se om navnene har endret seg:
```{r}
names(pend_02_24_arbBF_agg)
```

```{r}
names(pend_02_24_boBF_agg)
```

Slår sammen dataene pend_02_24_arbBF_agg og pend_02_24_boBF_agg til et felles datasett med bruuk av en rbind()

```{r}
boBF_arb_RAL <- pend_02_24_boBF_agg |>
  filter(akom == "k9999")
```
```{r}
pend_02_24 <- bind_rows(
  pend_02_24_arbBF_agg,
  boBF_arb_RAL
  )
```
Har laget så et datasett som heter pend_02_24 som vi skal bruke i fremtiden.

Noe info om datasettene:
```{r}
names(pend_02_24)
dim(pend_02_24)
```

```{r}
names(pend_02_24_arbBF_agg)
dim(pend_02_24_arbBF_agg)
```

```{r}
names(pend_02_24_boBF_agg)
dim(pend_02_24_boBF_agg)
```

Rydder så vekk tidligere dataseter:
```{r}
rm(boBF_arb_RAL, pend_02_24_arbBF, pend_02_24_boBF, 
   pend_02_24_ssb_arbBF, pend_02_24_ssb_boBF
   )
```

## Totalt antall arbeidstakere i hele landet per år

Vi må få laste ned alle bostedkommuner og alle jobbkommuner samtidig. 

```{r}
# oppdatert med "31", "32", "33", "39", "40", "55", "56"
# for splitting i 2024
fnr <- c(
  "30", "01", "02", "06", "03", "34", "04", "05", "38",
  "07", "08", "42", "09", "10", "11", "46", "12", "14",
  "15", "50", "16", "17", "18", "54", "19", "20", "31", 
  "32", "33", "39", "40", "55", "56"
  )
```

```{r}
#| cache: true
tot_arb_HL_ssb <- ApiData12(
    urlToData = "11616",
    Region = fnr,
    Alder = "15-74", # få med alle i lovlig arbeidsalder
    Tid = as.character(2002:2024)
)
```

```{r}
tot_arb_HL <- tot_arb_HL_ssb %>%
  group_by(Tid) %>%                       # ett år om gangen
  summarise(
    arbtak_HL = sum(value, na.rm = TRUE), # summer alle regioner = hele landet
    .groups = "drop"
  ) %>%
  rename(aar = Tid) %>%                   # gjør om kolonnenavn
  arrange(aar) %>%
  as_tibble()

# Vis toppen for kontroll
print(tot_arb_HL, n = Inf)
```


```{r}
BF <- c(knr_u_SSV, "k1103", "k1108", "k1160")
```

```{r}
# bor i BF jobber hele landet inkl. BF
bBFjHL <- pend_02_24 %>% 
  filter(bkom %in% BF) %>% 
  group_by(aar) %>% 
  summarise(bBFjHL = sum(pendlere))
```

```{r}
bRALjBF <- pend_02_24 %>%
  filter(!bkom %in% BF,     # bor utenfor BF (RAL)
         akom %in% BF) %>%  # jobber i BF
  group_by(aar) %>%
  summarise(bRALjBF = sum(pendlere), .groups = "drop")
```



```{r}
tot_arb_HL <- left_join(tot_arb_HL, bBFjHL, by = join_by(aar))
tot_arb_HL <- left_join(tot_arb_HL, bRALjBF, by = join_by(aar))
```

```{r}
total = tot_arb_HL %>% 
  select(aar, pendlere = arbtak_HL) %>% 
  mutate(
    akom = "k0000",
    akom_navn = "TotaltBo",
    bkom = "k0000",
    bkom_navn = "TotaltArb",
    .before = pendlere
  )
```










